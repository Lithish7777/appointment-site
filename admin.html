<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f3f3f3;
    }
    .card {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    img {
      max-width: 150px;
      height: auto;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .buttons {
      margin-top: 10px;
    }
    button {
      margin-right: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .accept { background-color: #4CAF50; color: white; }
    .reject { background-color: #f44336; color: white; }
    .download { background-color: #2196F3; color: white; }
    .details { margin-top: 10px; }
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
    }
    .modal img {
      display: block;
      margin: 50px auto;
      max-width: 90%;
      max-height: 90%;
    }
  </style>
</head>
<body>

  <h1>Admin Approval Dashboard</h1>
  <div id="appointments"></div>

  <div id="modal" class="modal" onclick="this.style.display='none'">
    <img id="modalImg" src="" alt="Full Size">
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appointmentsRef = collection(db, "appointments");

    function fixBase64(photo) {
      if (!photo) return null;
      if (photo.startsWith("data:image")) return photo;
      if (photo.startsWith("/9j/")) return `data:image/jpeg;base64,${photo}`;
      if (photo.startsWith("iVBOR")) return `data:image/png;base64,${photo}`;
      return `data:image/jpeg;base64,${photo}`;
    }

    function downloadBase64Image(base64, filename) {
      const link = document.createElement("a");
      link.href = base64;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function loadAppointments() {
      const snapshot = await getDocs(appointmentsRef);
      const container = document.getElementById("appointments");
      container.innerHTML = "";

      snapshot.forEach(async (docSnap) => {
        const data = docSnap.data();
        const base64Image = fixBase64(data.photo);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <strong>Name:</strong> ${data.name}<br>
          <strong>Email:</strong> ${data.email}<br>
          <div class="details">
            <strong>Date:</strong> ${data.date || "N/A"}<br>
            <strong>Time:</strong> ${data.time || "N/A"}
          </div>
          ${base64Image ? `<br><img src="${base64Image}" alt="Uploaded Photo" onclick="showModal('${base64Image}')"><br>` : ""}
          <div class="buttons">
            <button class="accept">Accept</button>
            <button class="reject">Reject</button>
            ${base64Image ? `<button class="download">Download</button>` : ""}
          </div>
        `;

        const [acceptBtn, rejectBtn, downloadBtn] = card.querySelectorAll("button");

        acceptBtn.onclick = async () => {
          await updateDoc(doc(appointmentsRef, docSnap.id), { status: "accepted" });
          alert("Accepted!");
        };

        rejectBtn.onclick = async () => {
          await updateDoc(doc(appointmentsRef, docSnap.id), { status: "rejected" });
          alert("Rejected!");
        };

        if (downloadBtn && base64Image) {
          downloadBtn.onclick = () => downloadBase64Image(base64Image, `${data.name || 'photo'}.png`);
        }

        container.appendChild(card);
      });
    }

    window.showModal = function(src) {
      document.getElementById("modalImg").src = src;
      document.getElementById("modal").style.display = "block";
    };

    loadAppointments();
  </script>
</body>
</html>
